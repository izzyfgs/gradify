{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gradify | Search</title>

  <style>
    :root{
      --purple-grad: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      --purple: #6d28d9;
      --ink:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --soft:#f8fafc;
      --shadow: 0 14px 35px rgba(2,6,23,0.08);
    }

    *{ box-sizing:border-box; }
    html, body{
      margin:0; padding:0;
      font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      background:#fff;
      color:var(--ink);
      overflow-x:hidden;
    }

    /* ===== TOP NAV ===== */
    .topnav{
      position:fixed;
      top:0; left:0; right:0;
      z-index:100;
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
      letter-spacing:-0.4px;
    }

    .logo{
      width:38px;
      height:38px;
      border-radius:12px;
      background: var(--purple-grad);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:950;
      box-shadow: 0 12px 25px rgba(109,40,217,0.25);
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      text-decoration:none;
      color:var(--ink);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 80px 14px 30px;
    }

    .title{
      font-size:18px;
      font-weight:950;
      margin: 8px 0 12px;
      letter-spacing:-0.4px;
    }

    .searchbar{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius:18px;
      padding: 12px 14px;
      background:#fff;
      box-shadow: var(--shadow);
    }

    .searchbar input{
      width:100%;
      border:none;
      outline:none;
      font-size:14px;
      font-weight:800;
      color:var(--ink);
      background:transparent;
    }

    .suggest{
      margin-top:12px;
      border:1px solid var(--border);
      background:#fff;
      border-radius:20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
    }

    .suggest.show{ display:block; }

    .user-row{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 12px 14px;
      cursor:pointer;
      text-decoration:none;
      color:var(--ink);
      border-bottom: 1px solid rgba(226,232,240,0.7);
    }

    .user-row:hover{ background: var(--soft); }

    .dp{
      width:44px; height:44px;
      border-radius:50%;
      overflow:hidden;
      background:#e2e8f0;
      flex-shrink:0;
      border: 2px solid rgba(226,232,240,0.8);
    }
    .dp img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }

    .u-meta{ flex:1; min-width:0; }

    .u-name{
      font-weight:950;
      font-size:14px;
      letter-spacing:-0.3px;
    }

    .u-handle{
      font-size:12px;
      font-weight:850;
      color:var(--muted);
    }

    .empty{
      padding: 14px;
      font-weight:900;
      color: var(--muted);
      text-align:center;
    }
    .arrow {
        color: var(--muted);
        font-weight: bold;
    }
  </style>
</head>
<body>

  <nav class="topnav">
    <div class="brand">
      <div class="logo">G</div>
      <div>Search</div>
    </div>
    <a class="btn" href="{% url 'dashboard' %}">Dashboard</a>
  </nav>

  <main class="wrap">
    <div class="title">Search users</div>

    <div class="searchbar">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0f172a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input id="searchInput" placeholder="Type a username..." autocomplete="off" />
    </div>

    <div id="suggestBox" class="suggest"></div>
  </main>
<script>
    const searchInput = document.getElementById("searchInput");
    const suggestBox = document.getElementById("suggestBox");
    let timer = null;

    function goToProfile(username) {
        window.location.href = "/profile/" + encodeURIComponent(username) + "/";
    }

    function renderUsers(users) {
        if (!users || users.length === 0) {
            suggestBox.innerHTML = `<div class="empty">No users found</div>`;
            suggestBox.classList.add("show");
            return;
        }

        let html = "";
        const fallback = "{% static 'images/default_avatar.jpg' %}";
        const timestamp = new Date().getTime();  // One timestamp per render

        users.forEach(u => {
            // Use avatar_url (the correct field from your API)
            console.log("Received user data:", u);
            
            let imgUrl = (u.avatar_url && u.avatar_url.trim() !== "" && 
                         u.avatar_url !== "/static/default.png" &&
                         u.avatar_url !== "/static/images/default_avatar.jpg")
                ? `${u.avatar_url}?t=${timestamp}`
                : `${fallback}?t=${timestamp}`;

            html += `
                <a class="user-row" href="javascript:void(0)" onclick="goToProfile('${u.username}')">
                    <div class="dp">
                        <img src="${imgUrl}" 
                             alt="${u.username}" 
                             onerror="this.onerror=null; this.src='${fallback}?t=${timestamp}';">
                    </div>
                    <div class="u-meta">
                        <div class="u-name">${u.username}</div>
                        <div class="u-handle">@${u.username}</div>
                    </div>
                    <div class="arrow">â€º</div>
                </a>
            `;
        });

        suggestBox.innerHTML = html;
        suggestBox.classList.add("show");
    }

    async function searchUsers(query) {
        if (!query.trim()) {
            suggestBox.innerHTML = "";
            suggestBox.classList.remove("show");
            return;
        }

        try {
            const res = await fetch(`/api/search-users/?q=${encodeURIComponent(query)}`);
            if (!res.ok) throw new Error("Server error");
            
            const data = await res.json();
            
            // Handle both raw array or {results: [...]} format
            const users = Array.isArray(data) ? data : (data.results || []);
            renderUsers(users);

        } catch (err) {
            console.error("Search Error:", err);
        }
    }

    searchInput.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            searchUsers(searchInput.value);
        }, 200);
    });

    document.addEventListener("click", (e) => {
        if (!suggestBox.contains(e.target) && e.target !== searchInput) {
            suggestBox.classList.remove("show");
        }
    });
</script>
</body>
</html>