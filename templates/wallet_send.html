{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gradify | Send Money</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --ink:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: 0 12px 30px rgba(2,6,23,0.08);
      --grad: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
      --purple:#6d28d9;
      --danger:#ef4444;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:Segoe UI, system-ui, Arial; background:var(--bg); color:var(--ink); }
    .wrap{ max-width: 560px; margin: 0 auto; padding: 18px 14px 30px; }

    .top{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px 0;
    }
    .back{
      text-decoration:none; color:var(--ink);
      font-weight:950;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      box-shadow: var(--shadow);
    }
    .title{ font-weight:950; font-size:16px; }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:16px;
      margin-top: 12px;
    }

    label{ display:block; margin-top:12px; font-weight:900; font-size:13px; color:var(--muted); }
    input, textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      font-weight:800;
      margin-top:6px;
      outline:none;
      background:#fff;
    }
    input:focus, textarea:focus{
      border-color: var(--purple);
      box-shadow: 0 0 0 4px rgba(109,40,217,0.08);
    }
    textarea{ resize:none; min-height: 90px; }

    /* Autocomplete specific styles */
    .search-container { position: relative; }
    .suggestions-box {
      position: absolute;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      margin-top: 4px;
      box-shadow: var(--shadow);
      display: none;
    }
    .suggestion-item {
      padding: 12px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
      border-bottom: 1px solid #f8fafc;
      display: flex;
      align-items: center;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background: #f1f5f9; color: var(--purple); }
    .suggestion-item::before {
      content: '@';
      margin-right: 4px;
      color: var(--muted);
      font-weight: 400;
    }

    .btn{
      width:100%;
      margin-top:14px;
      border:none;
      background:var(--grad);
      color:#fff;
      padding:14px;
      border-radius:18px;
      font-weight:950;
      cursor:pointer;
      font-size:14px;
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 850;
      color: var(--muted);
      text-align:center;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 13px;
      border: 1px solid var(--border);
      background:#fff;
    }
    .msg.error{ border-color: rgba(239,68,68,0.35); color: var(--danger); }
    .msg.success{ border-color: rgba(22,163,74,0.35); color: #16a34a; }
    .msg.warning{ border-color: #fbbf24; color: #d97706; }
  </style>
</head>
<body>

  <div class="wrap">

    <div class="top">
      <a class="back" href="{% url 'wallet' %}">‚Üê Wallet</a>
      <div class="title">Send Money</div>
      <div style="width:72px;"></div>
    </div>

    {% if messages %}
      {% for m in messages %}
        <div class="msg {% if m.tags %}{{ m.tags }}{% endif %}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    <div class="card">
      <form method="post" id="sendMoneyForm">
        {% csrf_token %}

        <label>Username</label>
        <div class="search-container">
          <input type="text" id="usernameInput" name="username" autocomplete="off" placeholder="Type a name..." required />
          <div id="suggestions" class="suggestions-box"></div>
        </div>

        <label>Amount ($)</label>
        <input type="text" name="amount" inputmode="decimal" placeholder="0.00" required />

        <label>Remark</label>
        <textarea name="remark" maxlength="200" placeholder="What's this for?" required></textarea>

        <label>Wallet PIN</label>
        <input type="password" name="pin" inputmode="numeric" maxlength="4" placeholder="****" required />

        <button class="btn" type="submit" id="submitBtn">Send Payment</button>
        <div class="hint">Funds are moved instantly across Gradify accounts.</div>
      </form>
    </div>

  </div>

  <script>
    const userInput = document.getElementById('usernameInput');
    const suggestionsBox = document.getElementById('suggestions');
    const submitBtn = document.getElementById('submitBtn');

    // Handle typing and searching
    userInput.addEventListener('input', async () => {
      const query = userInput.value.trim();
      
      if (query.length < 1) {
        suggestionsBox.style.display = 'none';
        return;
      }

      try {
        // Calls the endpoint we created in views.py
        const response = await fetch(`/user-search/?q=${query}`);
        const data = await response.json();

        if (data.results.length > 0) {
          suggestionsBox.innerHTML = '';
          data.results.forEach(username => {
            const div = document.createElement('div');
            div.classList.add('suggestion-item');
            div.textContent = username;
            div.onclick = () => {
              userInput.value = username;
              suggestionsBox.style.display = 'none';
            };
            suggestionsBox.appendChild(div);
          });
          suggestionsBox.style.display = 'block';
        } else {
          suggestionsBox.style.display = 'none';
        }
      } catch (err) {
        console.error('Search error:', err);
      }
    });

    // Close suggestion box when clicking outside
    document.addEventListener('click', (e) => {
      if (e.target !== userInput) {
        suggestionsBox.style.display = 'none';
      }
    });

    // Simple prevent double-submit
    document.getElementById('sendMoneyForm').onsubmit = function() {
      submitBtn.innerText = "Processing...";
      submitBtn.disabled = true;
      submitBtn.style.opacity = "0.7";
    };
  </script>

</body>
</html>